<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Directory</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: white;
      color: #111827;
    }

    * {
      box-sizing: border-box;
    }

    html, body, #app {
      height: 100%;
      width: 100%;
    }

    #app {
      overflow-y: auto;
      background: white;
    }

    .page-container {
      width: 100%;
      background: white;
    }

    .content-container {
      max-width: 1180px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    /* Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      margin: 0;
    }

    .total-pill {
      background: #F9FAFB;
      border: 1px solid #E5E7EB;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
    }

    /* Tabs */
    .tabs-row {
      display: flex;
      gap: 32px;
      margin-bottom: 24px;
      border-bottom: 1px solid #E5E7EB;
      padding-bottom: 0;
    }

    .tab-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 0;
      border: none;
      background: transparent;
      border-bottom: 2px solid transparent;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      color: #6B7280;
      position: relative;
      bottom: -1px;
    }

    .tab-item:hover {
      color: #2563EB;
    }

    .tab-item.active {
      color: #2563EB;
      border-bottom-color: #2563EB;
    }

    .tab-count {
      display: inline-block;
      padding: 2px 8px;
      background: #F3F4F6;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      color: #6B7280;
    }

    .tab-item.active .tab-count {
      background: #DBEAFE;
      color: #2563EB;
    }

    /* Filter Row Card */
    .filter-card {
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .search-wrapper {
      flex: 1;
      position: relative;
    }

    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #9CA3AF;
      width: 18px;
      height: 18px;
    }

    .search-input {
      width: 100%;
      height: 40px;
      padding: 0 14px 0 40px;
      border: 1px solid #E5E7EB;
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      color: #111827;
      transition: border-color 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: #2563EB;
    }

    .search-input::placeholder {
      color: #9CA3AF;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-label {
      font-size: 14px;
      font-weight: 500;
      color: #6B7280;
      white-space: nowrap;
    }

    .filter-select {
      height: 40px;
      padding: 0 32px 0 12px;
      border: 1px solid #E5E7EB;
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      background: white;
      color: #111827;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%236B7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      min-width: 120px;
    }

    .filter-select:focus {
      outline: none;
      border-color: #2563EB;
    }

    .sort-direction-btn {
      width: 40px;
      height: 40px;
      border: 1px solid #E5E7EB;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .sort-direction-btn:hover {
      background: #F9FAFB;
    }

    .view-toggle {
      display: flex;
      gap: 0;
      border: 1px solid #E5E7EB;
      border-radius: 10px;
      overflow: hidden;
      background: white;
    }

    .view-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      color: #6B7280;
    }

    .view-btn:first-child {
      border-right: 1px solid #E5E7EB;
    }

    .view-btn:hover {
      background: #F9FAFB;
    }

    .view-btn.active {
      background: #F3F4F6;
      color: #2563EB;
    }

    /* Student Grid */
    .students-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }

    @media (max-width: 640px) {
      .students-grid {
        grid-template-columns: 1fr;
      }
    }

    .student-card {
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      transition: all 0.2s;
    }

    .student-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .card-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #2563EB;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .card-header-info {
      flex: 1;
      min-width: 0;
    }

    .student-name {
      font-size: 15px;
      font-weight: 600;
      color: #111827;
      margin: 0 0 4px 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .student-code {
      font-size: 13px;
      color: #6B7280;
      margin: 0;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      flex-shrink: 0;
      align-self: flex-start;
    }

    .status-badge.active {
      background: #D1FAE5;
      color: #059669;
    }

    .status-badge.inactive {
      background: #FEF3C7;
      color: #D97706;
    }

    .status-badge.finished {
      background: #E0E7FF;
      color: #4F46E5;
    }

    .status-badge.dropped {
      background: #FEE2E2;
      color: #DC2626;
    }

    .card-body {
      margin-bottom: 18px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .info-row:last-child {
      margin-bottom: 0;
    }

    .info-label {
      font-size: 13px;
      color: #6B7280;
      font-weight: 400;
    }

    .info-value {
      font-size: 13px;
      color: #111827;
      font-weight: 600;
    }

    .card-footer {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .btn-primary {
      flex: 1;
      height: 36px;
      padding: 0 16px;
      background: #2563EB;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary:hover {
      background: #1D4ED8;
    }

    .btn-secondary {
      width: 36px;
      height: 36px;
      padding: 0;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6B7280;
    }

    .btn-secondary:hover {
      background: #F9FAFB;
      border-color: #D1D5DB;
    }

    /* Table View */
    .table-container {
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 14px;
      padding: 20px;
      overflow-x: auto;
    }

    .students-table {
      width: 100%;
      border-collapse: collapse;
    }

    .students-table thead {
      background: #F9FAFB;
    }

    .students-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 13px;
      font-weight: 600;
      color: #6B7280;
      border-bottom: 1px solid #E5E7EB;
    }

    .students-table th.actions {
      text-align: right;
    }

    .students-table td {
      padding: 16px;
      border-bottom: 1px solid #F3F4F6;
      font-size: 14px;
      color: #111827;
    }

    .students-table td.actions {
      text-align: right;
    }

    .students-table tbody tr:last-child td {
      border-bottom: none;
    }

    .students-table tbody tr:hover {
      background: #F9FAFB;
    }

    .table-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .btn-table {
      padding: 6px 12px;
      border: 1px solid #E5E7EB;
      background: white;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      color: #374151;
    }

    .btn-table:hover {
      border-color: #2563EB;
      color: #2563EB;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 14px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid #E5E7EB;
    }

    .modal-title {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #111827;
    }

    .modal-body {
      padding: 24px;
    }

    .info-section {
      margin-bottom: 24px;
    }

    .info-section:last-child {
      margin-bottom: 0;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #6B7280;
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .item-label {
      font-size: 12px;
      font-weight: 500;
      color: #9CA3AF;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .item-value {
      font-size: 14px;
      color: #111827;
      font-weight: 500;
    }

    .notes-box {
      background: #F9FAFB;
      border: 1px solid #E5E7EB;
      border-radius: 10px;
      padding: 12px;
      font-size: 13px;
      color: #374151;
      white-space: pre-wrap;
      max-height: 150px;
      overflow-y: auto;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #E5E7EB;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .btn-modal {
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }

    .btn-modal.secondary {
      background: white;
      color: #374151;
      border: 1px solid #E5E7EB;
    }

    .btn-modal.secondary:hover {
      background: #F9FAFB;
    }

    .btn-modal.primary {
      background: #2563EB;
      color: white;
      border: none;
    }

    .btn-modal.primary:hover {
      background: #1D4ED8;
    }

    /* Loading & Empty States */
    .loading-state, .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6B7280;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #E5E7EB;
      border-top-color: #2563EB;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 8px 0;
      color: #111827;
    }

    .empty-text {
      font-size: 14px;
      margin: 0;
      color: #6B7280;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1F2937;
      color: white;
      padding: 16px 20px;
      border-radius: 10px;
      font-size: 14px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
      z-index: 2000;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Icons */
    .icon {
      width: 18px;
      height: 18px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="app">
   <div class="page-container">
    <div class="content-container"><!-- Header -->
     <div class="page-header">
      <h1 class="page-title">Student Directory</h1>
      <div class="total-pill">
       Total: <span id="total-count">0</span>
      </div>
     </div><!-- Tabs -->
     <div class="tabs-row"><button class="tab-item active" data-status="active"> Active <span class="tab-count" id="count-active">0</span> </button> <button class="tab-item" data-status="finished"> Finished <span class="tab-count" id="count-finished">0</span> </button> <button class="tab-item" data-status="inactive"> Inactive <span class="tab-count" id="count-inactive">0</span> </button> <button class="tab-item" data-status="dropped"> Dropped <span class="tab-count" id="count-dropped">0</span> </button>
     </div><!-- Filter Card -->
     <div class="filter-card">
      <div class="search-wrapper">
       <svg class="search-icon" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
       </svg><input type="text" class="search-input" id="search-input" placeholder="Search students...">
      </div>
      <div class="filter-group"><span class="filter-label">Class:</span> <select class="filter-select" id="class-filter"> <option value="">All Classes</option> </select>
      </div>
      <div class="filter-group"><span class="filter-label">Sort:</span> <select class="filter-select" id="sort-select"> <option value="name-asc">Name</option> <option value="code-asc">Public Code</option> <option value="newest">Newest</option> <option value="oldest">Oldest</option> </select>
      </div><button class="sort-direction-btn" id="sort-direction" title="Toggle sort direction">
       <svg class="icon" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
       </svg></button>
      <div class="view-toggle"><button class="view-btn active" data-view="grid" title="Grid View">
        <svg class="icon" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
        </svg></button> <button class="view-btn" data-view="table" title="Table View">
        <svg class="icon" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
        </svg></button>
      </div>
     </div><!-- Loading State -->
     <div id="loading-state" class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading student data...</p>
     </div><!-- Grid View -->
     <div id="grid-view" class="students-grid" style="display: none;"></div><!-- Table View -->
     <div id="table-view" class="table-container" style="display: none;">
      <table class="students-table">
       <thead>
        <tr>
         <th>Public Code</th>
         <th>Full Name</th>
         <th>DOB</th>
         <th>Status</th>
         <th>School</th>
         <th>Class</th>
         <th class="actions">Actions</th>
        </tr>
       </thead>
       <tbody id="table-body"></tbody>
      </table>
     </div><!-- Empty State -->
     <div id="empty-state" class="empty-state" style="display: none;">
      <div class="empty-icon">
       üîç
      </div>
      <h3 class="empty-title">No students found</h3>
      <p class="empty-text">Try adjusting your filters or search terms</p>
     </div>
    </div>
   </div><!-- Student Detail Modal -->
   <div class="modal" id="student-modal">
    <div class="modal-content">
     <div class="modal-header">
      <h2 class="modal-title" id="modal-title"></h2>
     </div>
     <div class="modal-body" id="modal-body"></div>
     <div class="modal-footer"><button class="btn-modal secondary" id="modal-close">Close</button> <button class="btn-modal primary" id="modal-open-students">Open Tuition Payment</button>
     </div>
    </div>
   </div><!-- Toast Notification -->
   <div class="toast" id="toast"></div>
  </div>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDXu76EY-_Qg2rYr-xOBVjJHaULpDPPu-s",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "669809522922",
      appId: "1:669809522922:web:5c3fb3a2ed96ac83affd1e"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Element SDK Configuration
    const defaultConfig = {
      portal_title: 'Student Directory',
      primary_color: '#2563EB'
    };

    // Global State
    let allStudents = [];
    let allClasses = [];
    let filteredStudents = [];
    let currentView = 'grid';
    let currentTabStatus = 'active';
    let sortDirection = 'asc';
    let selectedStudent = null;

    // Helper Functions
    function removeDiacritics(str) {
      if (!str) return '';
      return str.normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/ƒë/g, 'd')
        .replace(/ƒê/g, 'D')
        .toLowerCase();
    }

    function formatDate(timestamp) {
      if (!timestamp) return '-';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function getClassName(classId) {
      if (!classId) return '-';
      const classObj = allClasses.find(c => c.id === classId);
      return classObj ? classObj.name : '-';
    }

    function getInitials(name) {
      if (!name) return '??';
      const parts = name.split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function getSelectedYear() {
      // Option A (simple): always use current year
      return new Date().getFullYear();

      // Option B (recommended later): read from a year dropdown in the portal
      // return parseInt(document.getElementById('year-filter').value) || new Date().getFullYear();
    }

    function buildTuitionPaymentUrl(student) {
      const year = getSelectedYear();
      return `Tuition_Payment.html?studentId=${encodeURIComponent(student.id)}&year=${encodeURIComponent(year)}`;
    }

    function updateTabCounts() {
      const active = allStudents.filter(s => s.status === 'active').length;
      const finished = allStudents.filter(s => s.status === 'finished').length;
      const inactive = allStudents.filter(s => s.status === 'inactive').length;
      const dropped = allStudents.filter(s => s.status === 'dropped').length;
      const total = allStudents.length;

      document.getElementById('count-active').textContent = active;
      document.getElementById('count-finished').textContent = finished;
      document.getElementById('count-inactive').textContent = inactive;
      document.getElementById('count-dropped').textContent = dropped;
      document.getElementById('total-count').textContent = total;
    }

    function filterAndSortStudents() {
      const searchTerm = removeDiacritics(document.getElementById('search-input').value);
      const classFilter = document.getElementById('class-filter').value;
      const sortBy = document.getElementById('sort-select').value;

      let filtered = [...allStudents];

      // Apply tab status filter
      if (currentTabStatus) {
        filtered = filtered.filter(s => s.status === currentTabStatus);
      }

      // Apply search filter
      if (searchTerm) {
        filtered = filtered.filter(student => {
          const searchableFields = [
            removeDiacritics(student.fullName || ''),
            removeDiacritics(student.publicCode || ''),
            removeDiacritics(student.school || ''),
            removeDiacritics(student.contacts?.studentPhone || ''),
            removeDiacritics(student.contacts?.parentPhone || ''),
            removeDiacritics(student.contacts?.parentName || '')
          ];
          return searchableFields.some(field => field.includes(searchTerm));
        });
      }

      // Apply class filter
      if (classFilter) {
        filtered = filtered.filter(s => s.classId === classFilter);
      }

      // Apply sorting
      filtered.sort((a, b) => {
        let comparison = 0;
        
        switch (sortBy) {
          case 'name-asc':
            comparison = (a.normalizedName || a.fullName || '').localeCompare(b.normalizedName || b.fullName || '');
            break;
          case 'code-asc':
            comparison = (a.publicCode || '').localeCompare(b.publicCode || '');
            break;
          case 'newest':
            comparison = (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
            break;
          case 'oldest':
            comparison = (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);
            break;
        }
        
        return sortDirection === 'desc' ? -comparison : comparison;
      });

      filteredStudents = filtered;
      renderStudents();
    }

    function renderStudents() {
      const loadingState = document.getElementById('loading-state');
      const gridView = document.getElementById('grid-view');
      const tableView = document.getElementById('table-view');
      const emptyState = document.getElementById('empty-state');

      loadingState.style.display = 'none';
      gridView.style.display = 'none';
      tableView.style.display = 'none';
      emptyState.style.display = 'none';

      if (filteredStudents.length === 0) {
        emptyState.style.display = 'block';
        return;
      }

      if (currentView === 'grid') {
        renderGridView();
        gridView.style.display = 'grid';
      } else {
        renderTableView();
        tableView.style.display = 'block';
      }
    }

    function renderGridView() {
      const gridView = document.getElementById('grid-view');
      gridView.innerHTML = '';

      filteredStudents.forEach(student => {
        const card = document.createElement('div');
        card.className = 'student-card';
        card.innerHTML = `
          <div class="card-header">
            <div class="avatar">${getInitials(student.fullName)}</div>
            <div class="card-header-info">
              <h3 class="student-name">${student.fullName || '-'}</h3>
              <p class="student-code">${student.publicCode || '-'}</p>
            </div>
            <span class="status-badge ${student.status || 'active'}">${(student.status || 'active').charAt(0).toUpperCase() + (student.status || 'active').slice(1)}</span>
          </div>
          <div class="card-body">
            <div class="info-row">
              <span class="info-label">Class:</span>
              <span class="info-value">${getClassName(student.classId)}</span>
            </div>
            <div class="info-row">
              <span class="info-label">DOB:</span>
              <span class="info-value">${formatDate(student.dob)}</span>
            </div>
          </div>
          <div class="card-footer">
            <button class="btn-primary" onclick="openTuitionPayment('${student.id}')">View Details</button>
            <button class="btn-secondary" onclick="copyStudentInfo('${student.id}')" title="Copy tuition payment link">
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
          </div>
        `;
        gridView.appendChild(card);
      });
    }

    function renderTableView() {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';

      filteredStudents.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${student.publicCode || '-'}</td>
          <td>${student.fullName || '-'}</td>
          <td>${formatDate(student.dob)}</td>
          <td><span class="status-badge ${student.status || 'active'}">${(student.status || 'active').charAt(0).toUpperCase() + (student.status || 'active').slice(1)}</span></td>
          <td>${student.school || '-'}</td>
          <td>${getClassName(student.classId)}</td>
          <td class="actions">
            <div class="table-actions">
              <button class="btn-table" onclick="openTuitionPayment('${student.id}')">View Details</button>
              <button class="btn-table" onclick="copyStudentInfo('${student.id}')">Copy Link</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    window.openTuitionPayment = function(studentId) {
      const student = allStudents.find(s => s.id === studentId);
      if (!student) return;
      const url = buildTuitionPaymentUrl(student);
      window.open(url, '_blank');
    };

    window.viewStudent = function(studentId) {
      const student = allStudents.find(s => s.id === studentId);
      if (!student) return;

      selectedStudent = student;

      const modal = document.getElementById('student-modal');
      const modalTitle = document.getElementById('modal-title');
      const modalBody = document.getElementById('modal-body');

      modalTitle.textContent = `${student.fullName || 'Student'} ‚Ä¢ ${student.publicCode || '-'}`;

      modalBody.innerHTML = `
        <div class="info-section">
          <h4 class="section-title">Basic Information</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="item-label">Public Code</span>
              <span class="item-value">${student.publicCode || '-'}</span>
            </div>
            <div class="info-item">
              <span class="item-label">Full Name</span>
              <span class="item-value">${student.fullName || '-'}</span>
            </div>
            <div class="info-item">
              <span class="item-label">Date of Birth</span>
              <span class="item-value">${formatDate(student.dob)}</span>
            </div>
            <div class="info-item">
              <span class="item-label">Status</span>
              <span class="item-value"><span class="status-badge ${student.status || 'active'}">${(student.status || 'active').charAt(0).toUpperCase() + (student.status || 'active').slice(1)}</span></span>
            </div>
            <div class="info-item">
              <span class="item-label">School</span>
              <span class="item-value">${student.school || '-'}</span>
            </div>
            <div class="info-item">
              <span class="item-label">Class</span>
              <span class="item-value">${getClassName(student.classId)}</span>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h4 class="section-title">Contact Information</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="item-label">Student Phone</span>
              <span class="item-value">${student.contacts?.studentPhone || '-'}</span>
            </div>
            <div class="info-item">
              <span class="item-label">Parent Name</span>
              <span class="item-value">${student.contacts?.parentName || '-'}</span>
            </div>
            <div class="info-item">
              <span class="item-label">Parent Phone</span>
              <span class="item-value">${student.contacts?.parentPhone || '-'}</span>
            </div>
            <div class="info-item">
              <span class="item-label">Emergency Contact</span>
              <span class="item-value">${student.contacts?.emergencyContact || '-'}</span>
            </div>
          </div>
        </div>

        ${student.notes?.academic || student.notes?.admin ? `
          <div class="info-section">
            <h4 class="section-title">Notes</h4>
            ${student.notes?.academic ? `
              <div class="info-item" style="margin-bottom: 12px;">
                <span class="item-label">Academic Notes</span>
                <div class="notes-box">${student.notes.academic}</div>
              </div>
            ` : ''}
            ${student.notes?.admin ? `
              <div class="info-item">
                <span class="item-label">Admin Notes</span>
                <div class="notes-box">${student.notes.admin}</div>
              </div>
            ` : ''}
          </div>
        ` : ''}
      `;

      modal.classList.add('show');
    };

    window.copyStudentInfo = function(studentId) {
      const student = allStudents.find(s => s.id === studentId);
      if (!student) return;

      const url = buildTuitionPaymentUrl(student);
      
      navigator.clipboard.writeText(url).then(() => {
        showToast('Tuition payment link copied');
      }).catch(() => {
        showToast('Failed to copy link');
      });
    };

    async function loadData() {
      try {
        // Load classes
        const classesSnapshot = await db.collection('classes').get();
        allClasses = classesSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        // Populate class filter
        const classFilter = document.getElementById('class-filter');
        classFilter.innerHTML = '<option value="">All Classes</option>';
        allClasses.forEach(classObj => {
          const option = document.createElement('option');
          option.value = classObj.id;
          option.textContent = classObj.name || classObj.id;
          classFilter.appendChild(option);
        });

        // Load students (exclude deleted)
        const studentsSnapshot = await db.collection('students')
          .where('isDeleted', '==', false)
          .get();

        allStudents = studentsSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        updateTabCounts();
        filterAndSortStudents();
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('Failed to load data. Please refresh the page.');
      }
    }

    // Event Listeners
    document.getElementById('search-input').addEventListener('input', filterAndSortStudents);
    document.getElementById('class-filter').addEventListener('change', filterAndSortStudents);
    document.getElementById('sort-select').addEventListener('change', filterAndSortStudents);

    document.getElementById('sort-direction').addEventListener('click', () => {
      sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      filterAndSortStudents();
    });

    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentView = btn.dataset.view;
        renderStudents();
      });
    });

    document.querySelectorAll('.tab-item').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTabStatus = tab.dataset.status;
        filterAndSortStudents();
      });
    });

    document.getElementById('modal-close').addEventListener('click', () => {
      document.getElementById('student-modal').classList.remove('show');
    });

    document.getElementById('modal-open-students').addEventListener('click', () => {
      if (selectedStudent) {
        const url = buildTuitionPaymentUrl(selectedStudent);
        window.open(url, '_blank');
        document.getElementById('student-modal').classList.remove('show');
      }
    });

    document.getElementById('student-modal').addEventListener('click', (e) => {
      if (e.target.id === 'student-modal') {
        document.getElementById('student-modal').classList.remove('show');
      }
    });

    // Element SDK Implementation
    async function onConfigChange(config) {
      // Update UI based on config changes if needed
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ['portal_title', config.portal_title || defaultConfig.portal_title]
      ]);
    }

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }

    // Initialize app
    loadData();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b9bc674166bdd8b',t:'MTc2NzcwODM3OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
